<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Better Southgate</title>
    <link rel='stylesheet' href='/stylesheets/staff.css' />
</head>
<body class="dashboard-page">
    <nav class="top-nav">
        <div class="nav-content">
            <div class="nav-left">
                <div class="logo-small">
                    <svg width="32" height="32" viewBox="0 0 40 40" fill="none">
                        <path d="M20 5L35 12.5V27.5L20 35L5 27.5V12.5L20 5Z" fill="#73B14B"/>
                        <path d="M20 15V25M15 20H25" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="nav-title">
                    <h2>Better Southgate</h2>
                    <span>Feedback Portal</span>
                </div>
            </div>
            <div class="nav-right">
                <a href="/staff/feedback" class="nav-link">All Feedback</a>
                <a href="/staff/logout" class="logout-btn">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none" stroke="currentColor">
                        <path d="M7 13L11 9L7 5M11 9H1M11 1H15C15.5304 1 16.0391 1.21071 16.4142 1.58579C16.7893 1.96086 17 2.46957 17 3V15C17 15.5304 16.7893 16.0391 16.4142 16.4142C16.0391 16.7893 15.5304 17 15 17H11" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <div class="dashboard-header">
            <div>
                <h1>Dashboard</h1>
                <p class="subtitle">Overview of customer feedback and satisfaction</p>
            </div>
        </div>

        <div class="period-filters">
            <span class="period-label">Showing:</span>
            <a href="/staff/dashboard?period=all" class="period-btn <%= currentPeriod === 'all' ? 'active' : '' %>">
                All Time
            </a>
            <a href="/staff/dashboard?period=ytd" class="period-btn <%= currentPeriod === 'ytd' ? 'active' : '' %>">
                Year to Date
            </a>
            <a href="/staff/dashboard?period=month" class="period-btn <%= currentPeriod === 'month' ? 'active' : '' %>">
                This Month
            </a>
            <a href="/staff/dashboard?period=lastmonth" class="period-btn <%= currentPeriod === 'lastmonth' ? 'active' : '' %>">
                Last Month
            </a>
            <span class="period-current">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke-width="2"/>
                    <line x1="16" y1="2" x2="16" y2="6" stroke-width="2"/>
                    <line x1="8" y1="2" x2="8" y2="6" stroke-width="2"/>
                    <line x1="3" y1="10" x2="21" y2="10" stroke-width="2"/>
                </svg>
                <%= periodLabel %>
            </span>
        </div>

        <div class="stats-grid">
            <div class="stat-card primary">
                <div class="stat-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Feedback</div>
                    <div class="stat-value"><%= totalFeedback %></div>
                </div>
            </div>

            <div class="stat-card warning">
                <div class="stat-icon">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" stroke-width="2"/>
                        <line x1="12" y1="9" x2="12" y2="13" stroke-width="2"/>
                        <line x1="12" y1="17" x2="12" y2="17" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Most Urgent Items</div>
                    <div class="stat-value"><%= mostUrgentFeedback.length %></div>
                </div>
            </div>
        </div>

        <div class="content-grid">
            <div class="panel activity-panel">
                <div class="panel-header">
                    <h3>Activity Breakdown</h3>
                    <span class="panel-badge"><%= activityBreakdown.length %> activities</span>
                </div>
                <div class="panel-content">
                    <% if (activityBreakdown.length === 0) { %>
                        <div class="empty-state">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" opacity="0.3">
                                <path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>No feedback in this period</p>
                        </div>
                    <% } else { %>
                        <div class="activity-list">
                            <% activityBreakdown.forEach(function(item) { %>
                                <div class="activity-item">
                                    <div class="activity-info">
                                        <span class="activity-name"><%= item._id %></span>
                                        <span class="activity-count"><%= item.count %> visits</span>
                                    </div>
                                    <div class="activity-bar">
                                        <div class="activity-bar-fill" style="width: <%= (item.count / totalFeedback * 100).toFixed(0) %>%"></div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    <% } %>
                </div>
            </div>

            <div class="panel rating-panel">
                <div class="panel-header">
                    <h3>Feedback Urgency Distribution</h3>
                </div>
                <div class="panel-content">
                    <% if (ratingBreakdown.length === 0) { %>
                        <div class="empty-state">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" opacity="0.3">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" stroke-width="2"/>
                            </svg>
                            <p>No feedback in this period</p>
                        </div>
                    <% } else { %>
                        <div class="rating-chart">
                            <% 
                            var ratingMap = {};
                            ratingBreakdown.forEach(function(item) {
                                ratingMap[item._id] = item.count;
                            });
                            var maxCount = Math.max(...ratingBreakdown.map(r => r.count), 1);
                            %>
                            
                            <% [5, 3, 1].forEach(function(rating) { %>
                                <div class="rating-row">
                                    <div class="rating-label">
                                        <% if (rating === 5) { %>
                                            <span class="rating-emoji happy">üèÉ</span>
                                            <span>Urgent</span>
                                        <% } else if (rating === 3) { %>
                                            <span class="rating-emoji neutral">üôã</span>
                                            <span>Worth a look</span>
                                        <% } else { %>
                                            <span class="rating-emoji sad">üêå</span>
                                            <span>Not Urgent</span>
                                        <% } %>
                                    </div>
                                    <div class="rating-bar">
                                        <div class="rating-bar-fill rating-<%= rating %>" 
                                             style="width: <%= (ratingMap[rating] || 0) / maxCount * 100 %>%"></div>
                                    </div>
                                    <div class="rating-count"><%= ratingMap[rating] || 0 %></div>
                                </div>
                            <% }); %>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <div class="panel recent-panel">
            <div class="panel-header">
                <h3>Recent Feedback</h3>
                <a href="/staff/feedback" class="view-all-link">
                    View all
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor">
                        <path d="M6 12L10 8L6 4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </a>
            </div>
            <div class="panel-content">
                <div class="feedback-list">
                    <% if (recentFeedback.length === 0) { %>
                        <div class="empty-state">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" opacity="0.3">
                                <path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <p>No feedback in this period</p>
                        </div>
                    <% } else { %>
                        <% recentFeedback.forEach(function(feedback) { %>
                            <div class="feedback-card">
                                <div class="feedback-header">
                                    <div class="feedback-meta">
                                        <span class="feedback-activity"><%= feedback.activity %></span>
                                        <span class="feedback-date"><%= new Date(feedback.createdAt).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }) %></span>
                                    </div>
                                    <div class="feedback-rating rating-<%= feedback.rating %>">
                                        <% if (feedback.rating === 5) { %>
                                            üèÉ
                                        <% } else if (feedback.rating === 3) { %>
                                            üôã
                                        <% } else { %>
                                            üêå
                                        <% } %>
                                    </div>
                                </div>
                                <p class="feedback-comment"><%= feedback.comments %></p>
                                <% if (feedback.name || feedback.email) { %>
                                    <div class="feedback-contact">
                                        <% if (feedback.name) { %>
                                            <span class="contact-name">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                                <%= feedback.name %>
                                            </span>
                                        <% } %>
                                        <% if (feedback.email) { %>
                                            <span class="contact-email">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                                    <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                    <polyline points="22,6 12,13 2,6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                                <%= feedback.email %>
                                            </span>
                                        <% } %>
                                    </div>
                                <% } %>
                            </div>
                        <% }); %>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</body>
</html>